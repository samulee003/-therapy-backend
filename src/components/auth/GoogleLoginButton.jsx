import React, { useState, useEffect, useContext } from 'react';
import {
  Button,
  CircularProgress,
  Alert,
  Box,
} from '@mui/material';
import GoogleIcon from '@mui/icons-material/Google';
import { googleLogin, googleRegister, getGoogleConfig } from '../../services/api';
import { AuthContext } from '../../context/AuthContext';

const GoogleLoginButton = ({ 
  onSuccess, 
  onError, 
  variant = 'outlined', 
  size = 'large', 
  fullWidth = true, 
  disabled = false,
  mode = 'login', // 'login' or 'register'
  role = 'patient' // for register mode
}) => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [googleClientId, setGoogleClientId] = useState('');
  const { refreshUser } = useContext(AuthContext);

  // Áç≤ÂèñGoogleÈÖçÁΩÆ
  useEffect(() => {
    const fetchGoogleConfig = async () => {
      try {
        console.log('üîç ÈñãÂßãÁç≤ÂèñGoogleÈÖçÁΩÆ...');
        const response = await getGoogleConfig();
        console.log('üì° Google config API response:', response);
        console.log('üìä Response data:', response.data);
        console.log('üîç Response data type:', typeof response.data);
        console.log('üîç Response data keys:', Object.keys(response.data || {}));
        
        // Ë©≥Á¥∞Ê™¢Êü•ÂæåÁ´ØËøîÂõûÁöÑÈÖçÁΩÆÊ†ºÂºè
        const responseData = response.data;
        console.log('üîç Details object:', responseData?.details);
        console.log('üîç Details keys:', Object.keys(responseData?.details || {}));
        
        const clientId = responseData?.details?.clientId || responseData?.clientId;
        console.log('üéØ Extracted Client ID:', clientId);
        console.log('üéØ Client ID type:', typeof clientId);
        console.log('üéØ Client ID length:', clientId?.length);
        
        if (clientId && clientId.trim()) {
          console.log('‚úÖ Setting Google Client ID:', clientId);
          const trimmedClientId = clientId.trim();
          setGoogleClientId(trimmedClientId);
          // ÂãïÊÖãËºâÂÖ•Google Identity ServicesÔºåÁõ¥Êé•ÂÇ≥ÈÅûclientId
          loadGoogleScript(trimmedClientId);
        } else {
          console.error('‚ùå No valid client ID found in response');
          console.error('‚ùå Response structure:', JSON.stringify(responseData, null, 2));
          setError('GoogleÈÖçÁΩÆ‰∏≠Áº∫Â∞ëÊúâÊïàÁöÑClient ID');
        }
      } catch (err) {
        console.error('‚ùå Failed to fetch Google config:', err);
        console.error('‚ùå Error details:', err.response?.data || err.message);
        setError('ÁÑ°Ê≥ïËºâÂÖ•GoogleÁôªÂÖ•ÈÖçÁΩÆ');
      }
    };

    fetchGoogleConfig();
  }, []);

  // Áï∂googleClientIdË®≠ÁΩÆÂæåÔºåÈáçÊñ∞ÂàùÂßãÂåñGoogleÊúçÂãô
  useEffect(() => {
    if (googleClientId && window.google) {
      console.log('Client ID updated, re-initializing Google...');
      initializeGoogle();
    }
  }, [googleClientId]);

  // ÂãïÊÖãËºâÂÖ•Google Identity ServicesËÖ≥Êú¨
  const loadGoogleScript = (clientId) => {
    console.log('üîÑ Loading Google script with Client ID:', clientId);
    
    if (window.google) {
      console.log('Google script already loaded, initializing with Client ID:', clientId);
      // Áõ¥Êé•ÂÇ≥ÈÅûclientIdÔºåÈÅøÂÖçÁãÄÊÖãÁï∞Ê≠•ÂïèÈ°å
      setTimeout(() => initializeGoogleWithClientId(clientId), 100);
      return;
    }

    console.log('Loading Google Identity Services script...');
    const script = document.createElement('script');
    script.src = 'https://accounts.google.com/gsi/client';
    script.async = true;
    script.defer = true;
    script.onload = () => {
      console.log('Google script loaded successfully');
      // Áõ¥Êé•ÂÇ≥ÈÅûclientIdÔºåÈÅøÂÖçÁãÄÊÖãÁï∞Ê≠•ÂïèÈ°å
      setTimeout(() => initializeGoogleWithClientId(clientId), 100);
    };
    script.onerror = () => {
      console.error('Failed to load Google script');
      setError('ÁÑ°Ê≥ïËºâÂÖ•GoogleÊúçÂãôËÖ≥Êú¨');
    };
    document.head.appendChild(script);
  };

  // ‰ΩøÁî®Áõ¥Êé•ÂÇ≥ÈÅûÁöÑclientIdÂàùÂßãÂåñGoogle Identity Services
  const initializeGoogleWithClientId = (clientId) => {
    console.log('üöÄ ÈñãÂßãÂàùÂßãÂåñGoogle Identity Services...');
    console.log('üîç Ê™¢Êü•ÂâçÁΩÆÊ¢ù‰ª∂:', {
      hasGoogle: !!window.google,
      hasClientId: !!clientId,
      clientIdValue: clientId,
      clientIdLength: clientId?.length,
      stateClientId: googleClientId,
      currentDomain: window.location.hostname,
      currentOrigin: window.location.origin
    });
    
    if (window.google && clientId && clientId.trim()) {
      console.log('‚úÖ ÂâçÁΩÆÊ¢ù‰ª∂ÊªøË∂≥ÔºåÈñãÂßãÂàùÂßãÂåñ...');
      console.log('üéØ ‰ΩøÁî®Client ID:', clientId);
      
      try {
        const config = {
          client_id: clientId.trim(),
          callback: handleCredentialResponse,
          auto_select: false,
          cancel_on_tap_outside: true,
          use_fedcm_for_prompt: false, // Á¶ÅÁî®FedCM‰ª•ÈÅøÂÖçÁ¨¨‰∏âÊñπCookieÂïèÈ°å
          context: 'signin' // ÊòéÁ¢∫ÊåáÂÆö‰∏ä‰∏ãÊñá
        };
        
        console.log('üîß GoogleÂàùÂßãÂåñÈÖçÁΩÆ:', config);
        
        window.google.accounts.id.initialize(config);
        console.log('‚úÖ Google Identity Services initialized successfully');
        
        // Ê∏¨Ë©¶GoogleÊúçÂãôÊòØÂê¶ÂèØÁî®
        if (window.google.accounts.id.prompt) {
          console.log('‚úÖ Google prompt method available');
        } else {
          console.warn('‚ö†Ô∏è Google prompt method not available');
        }
        
        // Ê∏¨Ë©¶ÂÖ∂‰ªñGoogleÊñπÊ≥ï
        console.log('üîç ÂèØÁî®ÁöÑGoogleÊñπÊ≥ï:', {
          hasPrompt: !!window.google.accounts.id.prompt,
          hasRenderButton: !!window.google.accounts.id.renderButton,
          hasRevoke: !!window.google.accounts.id.revoke
        });
        
      } catch (err) {
        console.error('‚ùå Failed to initialize Google Identity Services:', err);
        console.error('‚ùå Error details:', err.message, err.stack);
        setError(`GoogleÊúçÂãôÂàùÂßãÂåñÂ§±Êïó: ${err.message}`);
      }
    } else {
      console.log('‚ùå Cannot initialize Google - missing requirements:', {
        hasGoogle: !!window.google,
        hasClientId: !!clientId,
        googleObject: window.google ? 'exists' : 'missing',
        clientIdValue: clientId || 'empty',
        stateClientId: googleClientId || 'empty',
        currentDomain: window.location.hostname
      });
      
      if (!window.google) {
        setError('GoogleÊúçÂãôËÖ≥Êú¨Â∞öÊú™ËºâÂÖ•');
      } else if (!clientId) {
        setError('Google Client IDÊú™ÈÖçÁΩÆ');
      }
    }
  };

  // ‰øùÁïôÂéüÊúâÁöÑÂàùÂßãÂåñÂáΩÊï∏‰ΩúÁÇ∫ÂÇôÁî®
  const initializeGoogle = () => {
    initializeGoogleWithClientId(googleClientId);
  };

  // ËôïÁêÜGoogleÂõûË™ø
  const handleCredentialResponse = async (response) => {
    setLoading(true);
    setError('');

    try {
      let apiResponse;
      
      if (mode === 'register') {
        apiResponse = await googleRegister(response.credential, role);
      } else {
        apiResponse = await googleLogin(response.credential);
      }

      if (apiResponse.data && apiResponse.data.success) {
        // Âà∑Êñ∞Áî®Êà∂ÁãÄÊÖã
        await refreshUser();
        
        if (onSuccess) {
          onSuccess(apiResponse.data);
        }
      } else {
        throw new Error(apiResponse.data?.error || `Google${mode === 'register' ? 'Ë®ªÂÜä' : 'ÁôªÂÖ•'}Â§±Êïó`);
      }
    } catch (err) {
      console.error('Google authentication error:', err);
      const errorMessage = err.response?.data?.error || err.message || `Google${mode === 'register' ? 'Ë®ªÂÜä' : 'ÁôªÂÖ•'}Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶`;
      setError(errorMessage);
      if (onError) {
        onError(err);
      }
    } finally {
      setLoading(false);
    }
  };

  // Ëß∏ÁôºGoogleÁôªÂÖ•ÊµÅÁ®ã
  const handleGoogleLogin = async () => {
    console.log('Google login triggered', {
      hasGoogle: !!window.google,
      hasClientId: !!googleClientId,
      clientId: googleClientId,
      domain: window.location.hostname,
      origin: window.location.origin
    });

    if (!window.google) {
      setError('GoogleÊúçÂãôÂ∞öÊú™ËºâÂÖ•ÔºåË´ãÁ®çÂæåÂÜçË©¶');
      return;
    }

    if (!googleClientId) {
      setError('GoogleÈÖçÁΩÆÂ∞öÊú™ÂÆåÊàêÔºåË´ãÁ®çÂæåÂÜçË©¶');
      return;
    }

    try {
      setLoading(true);
      setError('');
      
      console.log('üöÄ Attempting to show Google prompt...');
      
      // Áõ¥Êé•‰ΩøÁî®renderButtonÊñπÊ≥ïÔºåÊõ¥Á©©ÂÆö
      tryRenderButton();
      
    } catch (err) {
      console.error('‚ùå Failed to trigger Google login:', err);
      setError(`ÁÑ°Ê≥ïÂïüÂãïGoogleÁôªÂÖ•: ${err.message}`);
      setLoading(false);
    }
  };

  // ‰ΩøÁî®renderButtonÊñπÊ≥ï
  const tryRenderButton = () => {
    try {
      console.log('üîß Using renderButton method...');
      
      // ÂâµÂª∫Ëá®ÊôÇÊåâÈàïÂÆπÂô®
      const tempDiv = document.createElement('div');
      tempDiv.style.position = 'absolute';
      tempDiv.style.top = '-9999px';
      tempDiv.style.left = '-9999px';
      tempDiv.style.width = '1px';
      tempDiv.style.height = '1px';
      tempDiv.style.overflow = 'hidden';
      document.body.appendChild(tempDiv);

      console.log('üéØ Rendering Google button...');
      
      window.google.accounts.id.renderButton(tempDiv, {
        theme: 'outline',
        size: 'large',
        type: 'standard',
        shape: 'rectangular',
        text: 'signin_with',
        logo_alignment: 'left',
        width: 250
      });

      // Á≠âÂæÖÊåâÈàïÊ∏≤ÊüìÂÆåÊàêÂæåÈªûÊìä
      setTimeout(() => {
        console.log('üñ±Ô∏è Attempting to click Google button...');
        const button = tempDiv.querySelector('div[role="button"]') || 
                      tempDiv.querySelector('button') || 
                      tempDiv.querySelector('[data-idom-class]');
        
        if (button) {
          console.log('‚úÖ Found Google button, clicking...');
          button.click();
        } else {
          console.error('‚ùå Google button not found in rendered content');
          setError('ÁÑ°Ê≥ïÊâæÂà∞GoogleÁôªÂÖ•ÊåâÈàï');
        }
        
        // Ê∏ÖÁêÜËá®ÊôÇÂÖÉÁ¥†
        setTimeout(() => {
          if (document.body.contains(tempDiv)) {
            document.body.removeChild(tempDiv);
          }
          setLoading(false);
        }, 1000);
      }, 500);
      
    } catch (err) {
      console.error('‚ùå RenderButton method failed:', err);
      setError(`GoogleÁôªÂÖ•ÊúçÂãôÊö´ÊôÇ‰∏çÂèØÁî®: ${err.message}`);
      setLoading(false);
    }
  };

  return (
    <Box sx={{ width: '100%' }}>
      {error && (
        <Alert 
          severity="warning" 
          sx={{ mb: 2 }}
          onClose={() => setError('')}
        >
          {error}
        </Alert>
      )}
      
      <Button
        variant={variant}
        size={size}
        fullWidth={fullWidth}
        disabled={disabled || loading}
        onClick={handleGoogleLogin}
        startIcon={loading ? <CircularProgress size={20} /> : <GoogleIcon />}
        sx={{
          py: 1.5,
          borderColor: '#dadce0',
          color: '#3c4043',
          backgroundColor: '#fff',
          '&:hover': {
            backgroundColor: '#f8f9fa',
            borderColor: '#dadce0',
          },
          '&:disabled': {
            backgroundColor: '#f8f9fa',
            borderColor: '#dadce0',
            color: '#9aa0a6',
          },
          textTransform: 'none',
          fontWeight: 500,
        }}
      >
        {loading 
          ? `${mode === 'register' ? 'Ë®ªÂÜä' : 'ÁôªÂÖ•'}‰∏≠...` 
          : mode === 'register' 
            ? `GoogleË®ªÂÜä (${role === 'patient' ? 'ÊÇ£ËÄÖ' : 'Ê≤ªÁôÇÂ∏´'})` 
            : 'GoogleÁôªÂÖ•'
        }
      </Button>
    </Box>
  );
};

export default GoogleLoginButton; 